<div class="chat-container">

  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <button class="toggle-sidebar-btn" (click)="toggleSidebar()" *ngIf="isSidebarCollapsed">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <span class="app-name" *ngIf="!isSidebarCollapsed">Conversas</span>
      <button class="new-conversation-btn"
              *ngIf="!isSidebarCollapsed"
              (click)="openNewConversation()"
              title="Nova conversa">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
      <button class="toggle-sidebar-btn" (click)="toggleSidebar()" *ngIf="!isSidebarCollapsed">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 19l7-7-7-7"/>
        </svg>
      </button>
    </div>

    <div class="user-list">
      <!-- PESQUISA (oculta quando colapsado) -->
      <div class="sidebar-search-wrapper" *ngIf="!isSidebarCollapsed">
        <svg class="sidebar-search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
        </svg>
        <input type="text"
               class="sidebar-search-input"
               placeholder="Pesquisar ou começar uma nova conversa"
               [(ngModel)]="sidebarSearch"
               (ngModelChange)="onSidebarSearch()" />
      </div>

      <!-- ABAS DE FILTRO (oculta quando colapsado) -->
      <div class="filter-tabs" *ngIf="!isSidebarCollapsed">
        <button class="filter-tab" [class.active]="(activeFilter$ | async) === 'all'" (click)="setFilter('all')">Todos</button>
        <button class="filter-tab" [class.active]="(activeFilter$ | async) === 'unread'" (click)="setFilter('unread')">Não lidas</button>
        <button class="filter-tab" [class.active]="(activeFilter$ | async) === 'favorites'" (click)="setFilter('favorites')">Favoritas</button>
        <button class="filter-tab" [class.active]="(activeFilter$ | async) === 'groups'" (click)="setFilter('groups')">Grupos</button>
      </div>

      <!-- TÍTULO -->
      <p class="user-list-title" *ngIf="!isSidebarCollapsed && !(isLoadingConversations$ | async)">Conversas</p>

      <!-- SKELETON (loading) -->
      <ng-container *ngIf="isLoadingConversations$ | async">
        <div class="user-item skeleton-item" *ngFor="let i of [1,2,3]">
          <div class="skeleton skeleton-avatar"></div>
          <div class="user-info" *ngIf="!isSidebarCollapsed">
            <div class="skeleton skeleton-name"></div>
            <div class="skeleton skeleton-msg"></div>
          </div>
        </div>
      </ng-container>

      <!-- EMPTY STATE (sem conversas após filtro) -->
      <div class="empty-sidebar" *ngIf="!(isLoadingConversations$ | async) && (filteredConversations$ | async)?.length === 0 && !isSidebarCollapsed">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <p>Nenhuma conversa</p>
        <span *ngIf="(activeFilter$ | async) !== 'all'">Tente mudar o filtro</span>
        <span *ngIf="(activeFilter$ | async) === 'all'">Clique no + para começar</span>
      </div>

      <!-- LISTA FILTRADA DE CONVERSAS -->
      <div class="user-item"
           *ngFor="let user of filteredConversations$ | async"
           [class.active]="(selectedUser$ | async)?.id === user.id"
           (click)="selectUser(user)">
        <div class="avatar">{{ user.avatarInitial }}</div>
        <div class="user-info" *ngIf="!isSidebarCollapsed">
          <div class="user-item-header">
            <span class="user-name">{{ user.name }}</span>
            <span class="last-message-time" *ngIf="user.lastMessageAt">
              {{ formatTime(user.lastMessageAt) }}
            </span>
          </div>
          <span class="user-last-msg">{{ user.lastMessage }}</span>
        </div>
        <!-- BADGE -->
        <span class="unread-badge" *ngIf="user.unreadCount && !isSidebarCollapsed">
          {{ user.unreadCount > 99 ? '99+' : user.unreadCount }}
        </span>
      </div>
    </div>

    <div class="sidebar-footer" (click)="toggleProfile()">
      <div class="avatar">V</div>
      <span class="my-name" *ngIf="!isSidebarCollapsed">Você</span>
    </div>
  </aside>

  <!-- Área de chat -->
  <main class="chat-main">
    <!-- EMPTY STATE (nenhuma conversa selecionada) -->
    <div class="chat-empty-state" *ngIf="!(selectedUser$ | async) && !(isLoadingConversations$ | async)">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <h3>Selecione uma conversa</h3>
      <p>Escolha um contato para começar a conversar</p>
    </div>

    <!-- CONTEÚDO (quando tem conversa selecionada OU carregando) -->
    <ng-container *ngIf="(selectedUser$ | async) || (isLoadingConversations$ | async)">
      <div class="chat-header" *ngIf="selectedUser$ | async as user">
        <div class="avatar chat-avatar-sm">{{ user.avatarInitial }}</div>

        <!-- Info do usuário -->
        <div class="chat-header-info">
          <span class="chat-user-name">{{ user.name }}</span>
          <span class="chat-user-status online" *ngIf="user.isOnline">Online</span>
          <span class="chat-user-status offline" *ngIf="!user.isOnline && user.lastSeenAt">
            Visto por último às {{ formatTime(user.lastSeenAt) }}
          </span>
          <span class="chat-user-status offline" *ngIf="!user.isOnline && !user.lastSeenAt">Offline</span>
        </div>

        <!-- Botões de ação -->
        <div class="chat-header-actions">
          <!-- Botão ⋮ opções -->
          <div class="options-wrapper">
            <button class="header-action-btn" (click)="toggleOptionsMenu()" title="Opções">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="5" r="1"/>
                <circle cx="12" cy="12" r="1"/>
                <circle cx="12" cy="19" r="1"/>
              </svg>
            </button>

            <!-- DROPDOWN MENU -->
            <div class="options-dropdown" *ngIf="isOptionsOpen$ | async">
              <button class="dropdown-item" (click)="toggleMute(user)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                  <line x1="23" y1="9" x2="17" y2="15"/>
                  <line x1="17" y1="9" x2="23" y2="15"/>
                </svg>
                {{ user.isMuted ? 'Ativar notificações' : 'Silenciar conversa' }}
              </button>
              <button class="dropdown-item" (click)="toggleFavorite(user)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="12 2 15.09 10.26 24 10.27 17.18 16.70 20.09 25 12 19.54 3.91 25 6.82 16.70 0 10.27 8.91 10.26 12 2"/>
                </svg>
                {{ user.isFavorite ? 'Remover dos favoritos' : 'Favoritar' }}
              </button>
              <button class="dropdown-item" (click)="clearHistory()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11z"/>
                </svg>
                Limpar histórico
              </button>
              <button class="dropdown-item danger" (click)="deleteConversation(user)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  <line x1="10" y1="11" x2="10" y2="17"/>
                  <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
                Excluir conversa
              </button>
            </div>
          </div>

          <!-- Botão fechar -->
          <button class="close-conversation-btn" (click)="closeConversation()" title="Fechar conversa">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- OVERLAY para fechar dropdown ao clicar fora -->
      <div class="options-overlay" *ngIf="isOptionsOpen$ | async" (click)="closeOptionsMenu()"></div>

      <div class="messages-area">
        <!-- SKELETON (carregando mensagens) -->
        <ng-container *ngIf="isLoadingMessages$ | async">
          <div class="skeleton-message skeleton-received">
            <div class="skeleton" style="width:220px;height:38px;border-radius:12px"></div>
          </div>
          <div class="skeleton-message skeleton-sent">
            <div class="skeleton" style="width:160px;height:38px;border-radius:12px"></div>
          </div>
          <div class="skeleton-message skeleton-received">
            <div class="skeleton" style="width:280px;height:38px;border-radius:12px"></div>
          </div>
        </ng-container>

        <!-- MENSAGENS REAIS (quando carregado e tem conversa selecionada) -->
        <ng-container *ngIf="!(isLoadingMessages$ | async) && (selectedUser$ | async)">
          <div class="message"
               *ngFor="let msg of messages$ | async"
               [class.sent]="msg.isSent"
               [class.received]="!msg.isSent">
            <span class="msg-content">{{ msg.content }}</span>
            <div class="msg-meta">
              <span class="msg-time">{{ formatTime(msg.timestamp) }}</span>
              <!-- Ticks só em mensagens enviadas -->
              <span class="msg-ticks" *ngIf="msg.isSent">
                <!-- ✓✓ lida (azul) -->
                <svg class="ticks read" *ngIf="msg.isRead" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <!-- ✓✓ entregue (cinza) -->
                <svg class="ticks delivered" *ngIf="!msg.isRead" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </span>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="message-input-area" *ngIf="selectedUser$ | async">
        <input type="text" placeholder="Digite uma mensagem..." class="message-input" />
        <button class="send-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
          </svg>
        </button>
      </div>
    </ng-container>
  </main>

  <app-profile-drawer></app-profile-drawer>

  <app-new-conversation-modal></app-new-conversation-modal>

</div>
